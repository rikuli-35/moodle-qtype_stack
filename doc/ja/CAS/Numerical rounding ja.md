# 数値の四捨五入

Maximaは内部的に浮動小数点数を2進数で表現しているため、10進数では正確になるような単純な計算（例えば、0.16 + 0.12）であっても、直接入力した結果と厳密には一致しないことがある。

デスクトップ版Maximaで`452-4.52*10^2`を試してみてみると、結果は0にならず、`ATAlgEquiv(452,4.52*10^2)`は失敗する。(Maxima 5.44.0, 2022年12月時点)。$\mathrm{4.52\times 10^2}$は2進浮動小数で表現すると循環する9が生じるため、整数$\mathrm{452}$と代数的に等価にならない。

このような四捨五入は次のような計算でも起こりうる。

    p1:0.29;
    p2:0.18;
    p3:0.35;
    v0:1-(p1+p2+p3)；
    v1:0.18;

Maximaは`v0`に対して`0.18`を返すが(予想通り)、`v0-v1`は$\mathrm{5.551115123125783\times 10^{-17}}$隣るため、`ATAlgEquiv(v0,v1)`はfalseを返す。浮動小数点数を判定するときは、必ず[数値テスト](../Authoring/Answer_Tests/Numerical.md)を使用すること。

別の例として、デスクトップのMaximaセッションで`100.4-80.0;`を試してみると良い。

## 四捨五入に関する注意事項 ##

末尾が$\mathrm{5}$の数を四捨五入する方法は2つある。

* 常に切り上げる方法($\mathrm{0.5 \rightarrow 1, 1.5 \rightarrow 2, 2.5 \rightarrow 3}$など)
* もう一つの一般的な方法は、「銀行丸め」を使うことである。銀行丸めとは、数量を整数に丸めるためのアルゴリズムであり、最も近い2つの整数から等距離にある数を最も近い偶数に丸める($\mathrm{0.5 \rightarrow 0, 1.5 \rightarrow 2, 2.5 \rightarrow 2}$など)。銀行丸めの利点は、極限的に見て偏りがなく、丸めを含むいくつかの統計処理でより良い結果が得られることである。
* 実験的な作業においては、有効数字の桁数がその数字の最初の桁に依存することがある。例えば、1桁目が$\mathrm{1}$や $\mathrm{2}$の場合、相対誤差を十分に小さくするために有効数字を1桁多く取る必要がある。この判定を行うための専用の内部関数が用意されるまでは、Maximaの文字列関数を用いて数値の最初の桁を確認することができる。

Maximaの`round(ex)`コマンドは1/2の倍数を最も近い偶数の整数に四捨五入する。つまり、銀行丸めが実装されている。現在のところ、常に切り上げるオプションはない。

STACKでは常に切り上げを行うための関数 `significantfigures(x,n)`が定義されている。

## ATAlgEquivと浮動小数点数 ##

浮動小数点数に対して代数的等価判定は使用しないこと推奨する。その代わりに、[数値判定](../Authoring/Answer_Tests/Numerical.md) のいずれかを使用すること。

数値のリストには、数値の四捨五入に関する問題を引き起こす。`AAlgEquiv`の解答テストはリストや行列などでも動作する。 しかし、数値判定は単一の浮動小数点数を想定しており、リストなどは受け付けない。

数値のリストがある場合、フィードバック変数内でに次のようにする方法がある。

````
/* taは教師側の解答である。
   ans1は学生の解答である。
   行列を作成する。
   */
S:matrix(LSG1-ans1)；
/* 行列のノルムを計算する。*/
N:ev(S.transpose(S),simp)；
/* ATGT(1E-10,N)を用いて、これが1E-10より小さいことを判定する。*/
````
他の方法としては、最大誤差を求めるために`ev(max(map(abs, S), simp)`を用いることが挙げられる。