# ポテンシャル・レスポンス・ツリー

ポテンシャル・レスポンス・ツリー（PRT）は、学生の解答の数学的特性を判定し、結果を割り当てるためのアルゴリズムである。使用例については、クイックスタートガイドの[フィードバックの改善](../AbInitio/Authoring_quick_start_3.md)を参照のこと。

## ツリーはいつ使用されるか ##

各ポテンシャル・レスポンス・ツリーは、1つ以上の[解答欄](../Authoring/Inputs/index.md)に依存する。STACKは[評価関数](Answer_Tests/index.md)や[フィードバック変数](Variables.md#Feedback_variables)でどの要素が必要かを自動的に検出する。学生が解答欄に初めて入力を送信すると、その入力は検証される。2回目の送信時に、ポテンシャル・レスポンス・ツリーによる評価が行われる。ツリーが依存するすべての解答欄の入力が有効で送信済みである場合にのみ、ツリーが走査される。

## ツリーが走査される前に ##

各ポテンシャル・レスポンス・ツリーでは、Maximaの[簡略化](../CAS/Simplification.md)のレベルを設定できる。ツリーが走査される前に、[フィードバック変数](Variables.md#Feedback_variables)が評価される。フィードバック変数は、[問題変数](Variables.md#Question_variable.s)と[解答欄](../Authoring/Inputs/index.md)の値に依存する。これらの変数の値は[評価関数](Answer_Tests/index.md)およびツリー内のすべての[CASText](CASText.md)フィールドで利用可能である。たとえば、これらの変数を使ってフィードバックを構築することができる。

注意事項：

1. 解答欄と同じ名前のフィードバック変数を定義することはできない。たとえば、解答欄が`ans1`の場合、小文字に変換するためにフィードバック変数`ans1:exdowncase(ans1)`を定義したくなるかもしれないが、これは行わないこと。別の変数名を使用すること。これは、状況によっては評価関数が学生の入力した`ans1`の生の値をそのまま使用することがあるためである。再定義するとこのプロセスに干渉してしまう。

2. フィードバック変数の1つがエラーを発生させても、PRTの実行は停止しない。エラーが発生した場合、レスポンスサマリーに`[RUNTIME_FV_ERROR]`（ここでのfvはフィードバック変数を意味する）と表示される。この機能の使い方については[エラー処理](Error_trapping.md)を参照のこと。

3. フィードバック変数によってポテンシャル・レスポンス・ツリーの実行を停止させることも可能である（解答欄の1つが空白/無効であった場合と同様である）。ただし、これは高度な使用例である。詳細は以下を参照のこと。

## ツリーの走査

ポテンシャル・レスポンス・ツリー（厳密には非巡回有向グラフ）は、ポテンシャル・レスポンスと呼ばれる任意の数のリンクされたノードで構成される。

各ノードでは、指定された[評価関数](Answer_Tests/index.md)を使って2つの式が比較され、結果は`true`または`false`のいずれかになる。ツリーの対応する分岐では、それぞれ以下の処理を行うことができる。

1. 点数を調整する（例：値を代入する、値を加減する）。点数は浮動小数点数でも、別の場所で定義された変数（問題変数やフィードバック変数など）でもかまわない。
2. 学生向けに個別のフィードバックを追加する。
3. 教師が評価分析に使用する「[解答記録](Potential_response_trees.md#Answer_note)」を生成する。
4. 次のノードを指定するか、処理を終了する。
5. ツリーの走査中に実行時エラーが発生するとエラーになる。このエラーはツリーの実行を停止し、学生には実行時エラーメッセージが表示される。このエラーはレスポンスサマリーに`[RUNTIME_ERROR]`として記録される。エラーを発生させる可能性のある文がある場合は、まずフィードバック変数で評価する必要がある。この使い方については[エラー処理](Error_trapping.md)を参照のこと。

## 結果 ##

ポテンシャル・レスポンス・ツリーの実行結果は以下のとおりである。

1. 生得点
2. この試行に対する減点
3. 学生への[フィードバック](Feedback.md)（詳細は以下を参照）
4. 解答記録

### 比重 {#Question_value}

ポテンシャル・レスポンス・ツリー自体は、\(0\)から\(1\)までの数値の素点を返すことが想定されている。この数値は、[フィードバック](Feedback.md)として学生に返されるか、データベースに記録される前に、比重が乗算される。

### 解答記録 {#Answer_note}

解答記録はレポート目的で使用されるタグである。各評価関数の結果と、ツリーを通る一意のパスを記録するように設計されている。これは自動的に生成されるが、変更することもできる。ツリーを通る同一のパスを特定する際には、特定の学生に与えられた問題のどの乱数が選択されたかに関係なく判断する必要がある。そのため、この文字列はどの変数にも依存しない。

解答記録は、[評価関数](Answer_Tests/index.md)の各解答記録と、対応する真/偽の分岐を連結したものである。このノートには、各テストを適用した結果と、ツリーを通過した経路が記録されている。

このフィールドにはデフォルト値が自動的に設定され、学生の学習状況の[レポート](../STACK_question_admin/Reporting.md)に使用される。

このフィールドは空にすることはできない。また、ツリーの各ノードに対して、この文字列は一意でなければならない。

解答記録では`;`、`|`の文字を使用しないこと。これらの文字は、レポートスクリプトでレスポンスサマリーを分割するために使用される。

## 得点と減点 ##

得点は各ポテンシャル・レスポンス・ツリーによって生成される。ツリーはすべての解答欄の入力が有効な場合にのみ走査されるため、得点は有効な試行に対してのみ生成される。

得点が生成される場合、それは解答欄の現在の値のみに基づく。つまり、(1)以前の入力値や(2)以前の試行回数には基づかない。（試行回数を利用可能にする要望が出されているが、まだ実装されていない。）

得点が生成された場合、減点も生成される。減点（ペナルティ）システムは、形成的な環境で学生に繰り返しの試行を促すように設計されている。たとえば、学生が\( \int x^2\, \mathrm{d}x\)を求めるように出題されたとする。

試行1： \( x^3/3\)。 得点\(=0\)、減点\(=0.1\)、フィードバック：「積分定数が抜けています。」

試行2： \( x^3/3+c\)。 得点\(=1\)、減点\(=0\)、フィードバック：「よくできました。」

全体として、ポテンシャル・レスポンス・ツリーは現在の得点からこれまでの減点の合計を差し引いた値を返し、この例では\(0.9\)になる。これに、ポテンシャル・レスポンス・ツリーに設定されている「比重」が掛けられる。すべてのポテンシャル・レスポンス・ツリーにわたって合算される。

この例では、積分定数の欠落に対して0点と減点ではなく、部分点を与えることを好む教員もいる。学生に再挑戦の機会がある形成的な環境では、減点システムが学生に再挑戦とフィードバックの確認を促す効果的な方法であることがわかっている。フィードバックがなく再試行が行われない試験では、別の判断が必要であり、0点よりも部分点を与えるほうが適切である。

* 減点には問題内でデフォルト値が設定される。これは必須フィールドであり、STACKのデフォルトは0.1である。
* 減点は累積されるが、学生には取得可能な最高点が与えられる。つまり、減点が累積される一方で、繰り返し問題に挑戦しても悪化することはない。特に、上の例の学生がもう一度挑戦して\(0\)点を取った場合、\(0.9\)点は保持される。これは形成的な環境で学生に再挑戦を促すためである。STACKは各試行に対して減点調整済みの得点リストを生成し、その最大値を採用する。
* 減点は、ポテンシャル・レスポンス・ツリーのノードごとに異なる値を割り当てることができる。これにより、たとえば教師が特定の解答に対して累積減点を設定できる。
* 減点は小テストレベルでも「問題ビヘイビア」メカニズムによって制御される。したがって、問題のビヘイビアを「アダプティブモード（ペナルティなし）」に設定した場合、割り当てられた減点は、小テストで学生がその問題を使用する際に無視される。

## 形成的ポテンシャル・レスポンス・ツリー ##

得点、減点、フィードバック、ノートの結果は常に生成される。通常、この情報を学生に表示するかどうかは小テスト、Moodleでは問題の動作の設定に依存する。個々の問題のレベルで設定すべきではない。

まれではあるが、純粋に形成的なPRTが必要となる状況がある。

例：解答欄AとBを持つ問題を考えてみよう。

1. 解答欄Aが正しいかどうかを判定する専用のPRTがある。
2. 解答欄Bが正しいかどうかを判定する専用のPRTがある。
3. 解答欄AとBの両方に依存する追加のPRTがある。このPRTは学生に形成的なフィードバックを提供する（例：「次はもっと面白い答えの組み合わせを試してみましょう！」）が、AとBの正誤判定には影響しない。

形成的ポテンシャル・レスポンス・ツリーでは、「正解です、よくできました」のような一般的なフィードバックはない。評点が付くことはなく、このPRTの評点は問題全体の得点や解答の完成度に寄与しない。

## PRTのフィードバック

PRTが生成するフィードバックは、以下の部分を連結したものである。

    [一般的なフィードバック] [実行時エラー] [PRTが生成したフィードバック] [得点?]

`[一般的なフィードバック]`は「正解の場合のフィードバック」のような問題レベルのオプションであり、問題全体で一貫性を保つためのものである。デフォルトでは、`[一般的なフィードバック]`には正誤の記号と言語テキストの両方が含まれる。現在の「正解」のデフォルトは以下のとおりである。

<span style="font-size: 1.5em; color:green;"><i class="fa fa-check"></i></span> よくできました。正解です！

PRTのフィードバックの表示方法は、PRTオプションの「フィードバックのスタイル」で以下のように制御される。デフォルト設定のままの場合、一般的なフィードバックに記号が含まれることに注意すること。

Value | Options | Symbol | Generic feedback | Errors | PRT feedback | Score
------|--------------|--------|------------------|--------|--------------|------------------------------------------
  0   | 形成的       |  なし  |  なし            |  あり  |  あり        | PRTは得点に寄与しない
  1   | 標準         |  なし  |  あり            |  あり  |  あり        | 小テスト設定に従う
  2   | 簡易         |  あり  |  なし            |  あり  |  あり        | 表示しない
  3   | 記号のみ     |  あり  |  なし            |  あり  |  なし        | 表示しない

「簡易」のPRTフィードバックは`<div>`ではなく`<span>`タグを使用することに注意すること。これにより、新しい段落を設けることなくインラインで埋め込むことができる。ただし、`<span>`タグは`<div>`や`<p>`のようなブロックレベル要素を含めることができない。そのため、PRTフィードバックにブロックレベル要素を含めると表示位置がずれてしまうことがある。また、このようなHTMLエラーがある場合、MathJaxはページ上の数式を正しく表示できないことがある。「簡易」フィードバックを使用する場合は、ブロックレベルのHTML要素を使用せず、最小限のPRTフィードバックのみを記述すること。

## フィードバック変数内でのレスポンスツリーの停止

STACKは、評価の仕組みの「モデル」を実装している。学生は「解答欄」を通じてやり取りし、システムはレスポンスツリーでこれらの入力の特性を判定する。レスポンスツリーは、空でない入力が「有効」であるときに自動的に実行される。(i)形成的ポテンシャル・レスポンス・ツリー、特に(ii)解答欄の`allowempty`オプションの導入により、このモデルが拡張された。

たとえば、`allowempty`オプションは 解答欄 のプロパティであり、レスポンスツリーのプロパティではない。ある解答欄について、あるレスポンスツリーでは空の入力を許可し、別のレスポンスツリーでは許可しない、ということを解答欄の設定で指定することはできない。複数のレスポンスツリーを使用する高度な使用例（おそらく形成的なもの）では、PRTが実行されるタイミングをより細かく制御する必要がある。

このため、フィードバック変数での前処理によって特定のポテンシャル・レスポンス・ツリーの実行を停止できるようにすると便利なことがある。停止して離脱する動作は、解答欄の入力が空白/無効であると判断される場合と同様の扱いである。得点は更新されず、フィードバックも生成されない。この「試行」は減点システムにおいて減点の対象にならない。

STACKは特別な定数`%stack_prt_stop_p`を提供している。デフォルトでは、各PRTのフィードバック変数の開始時に`false`に設定される。フィードバック変数の最後でこの値が`true`と評価されると、PRTは実行されずプロセスは離脱する。

たとえば、`ans1`が空かどうかをチェックするために、以下をフィードバック変数に追加できる。

    %stack_prt_stop_p:if is(ans1=EMPTYANSWER) then true else false;

（入力の種類によって空の解答を示す方法は異なる。`[EMPTYANSWER]`を使用するものもあれば、行列のように行列のサイズを反映するものもある。これは、空の解答の型が通常の入力の解答の型と一致するようにするためである。）

PRTの実行が開始された後は、離脱したり、ツリーの結果を無視する方法はない。離脱するかどうかの判断はフィードバック変数の中で行う必要がある。（このオプションを追加するための説得力のある使用例がある場合は、開発者に連絡すること。）

PRTは`prt1-bail`というノートを返し、ツリーが実行されようとしたが停止して離脱したことを示す。これは、PRTがまったく実行されなかったことを示すノート`!`とは対照的である。

この機能は、複数の解答欄と形成的PRTを使用する場合に役立つ。学生に最大3つの式の例を挙げるよう求める次のような問題を考えてみよう（例：「○○の例を挙げなさい」）。

1. 3つの解答欄`ans1`、`ans2`、`ans3`がある。関連する特性を判定するために、それぞれに1つのPRTがある。
2. すべてが異なることを確認するための別のPRTがある。
3. 形成的PRTがあり、たとえば「あなたの例はすべて多項式です。別のものを試してみてください」のようなフィードバックを提供する。

学生が2つの例のみを入力し、`ans3`は空欄にした場合を考える。

すべての解答欄を`allowempty`オプションで設定し、最後の2つのPRTで`EMPTYANSWER`をフィルタリングする。最後の2つのPRTは、学生が2つの例しか入力していない場合でも動作する。最初の3つのPRTでは、解答欄が空のときに離脱することができる。
