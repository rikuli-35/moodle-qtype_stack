# インクルード

STACK は、問題間でコードを共有するメカニズムを提供します。例えば、特定のトピックに特化した Maxima 関数の小さなライブラリを問題変数に含めることができます。

(i) 問題間で関数のライブラリを再利用することと (ii) [将来性を考慮したガイドライン](../STACK_question_admin/Future_proof.md) にある「自己完結型教材の原則」の間にはトレードオフがあります。これは高度なトピックです。

技術的な注意：現在、ループの検出とセキュリティ検証の理由から、インクルード内のインクルード（入れ子）はサポートされていません。

## インクルードのライフサイクル

現在サポートされているすべてのタイプのインクルードにおいて、インクルードは問題のコンパイル時に行われます。つまり、ソースとなる外部コードは問題がコンパイルされる際に取得され、キャッシュされたコンパイル生成物の中に保持されます。コンパイルは、問題が保存された後、あるいはキャッシュが削除された後の、その問題の最初の使用時に実行されます。

インクルードのロジックは、外部ソース資料の変更を追跡しません。再度取得したい場合は、キャッシュを削除するか、問題を編集して保存し直し、問題を再コンパイルする必要があります。

エクスポート時には、ソースアドレスのみがエクスポートされます。エクスポートされた教材は、インポートする側の環境からそのアドレスにアクセスできる場合にのみ機能します

## テキスト内のインクルード

より単純なインクルードタイプは CASText2 の インクルージョンブロックで、これは単に指定されたアドレスからの CASText2 コードをブロックの位置に配置するものです。コンテキスト（記述されている場所）とインクルードされるコードのフォーマットには注意が必要である点に留意してください。インクルードのロジックは、コードがコンテキストと同じフォーマットであると仮定します。そのため、もしインクルードされるコンテンツがMarkdown形式で、それをHTMLコンテキストに直接インクルードした場合、トラブルの原因となる可能性があります。

典型的なユースケースとしては、特定の変数が描画用のパラメータを含んでいることを期待するJSXGraphやGeoGebraの描画ロジックを用意する場合が挙げられます。その場合、例えば以下のように、描画ロジックをインクルードする前に、それらのパラメータに確実に値を設定するだけで済みます。

```text
まず、先に定義した値を用いてプロットを描画します。
[[include src="http://example.com/fragments/myplot.txt"/]]

次に、同じ描画ロジックをインクルードしますが、パラメータを変更して別のものを描画します。
[[define plot_fun="theotherfun" plot_param1="something"/]]
[[include src="http://example.com/fragments/myplot.txt"/]]

```

インクルードされるコンテンツは、コンテキストとは異なる形式（Markdown など）である可能性があるため、インクルードされるコンテンツ自身がその形式を定義することが推奨されます。例えば、新しい形式制御ブロック `[[moodleformat]]`, `[[htmlformat]]`, `[[markdownformat]]` のいずれかでコンテンツを囲むことで、どのような形式のコンテンツも他の形式のコンテンツ内にインクルードできるようになります。現時点では、数式モードの識別機能は、これらのコンテキスト切り替えのすべてを完全には理解できていないことに注意してください。

## CAS ロジック内のインクルード

コードを問題変数やフィードバック変数にインクルードすることもできます。
このタイプのインクルードは、問題作成者がコード内のその場所に直接書いたのとまったく同様に機能します。
もしこのタイプのインクルードを if 文の中に書いた場合、それは単に if 文の中に展開されて記述されます。`if` はそれが実行されるかどうかを決定するだけであり、インクルードしたコンテンツのデータ容量や通信リソースはその分だけ消費されることになります

インクルードされるコンテンツは、以下にある通常のSTACKの変数が満たすすべてのルールに従う必要があります。

1. 大量のコードはパフォーマンスに影響を与えます。内部の Maxima コードはプリコンパイルされていますが、問題変数は実行時に解釈されます。
2. インクルードされたコード内で定義されたすべての識別子は、直接入力した場合と同様にチェックの対象となります。
3. コード内の識別子は、学生にとっての禁止ワードとしてマークされます。したがって、問題間でロジックを共有する際、識別子の選択に際は特に注意が必要です。学生が他の問題で入力するかもしれない名前は使用しないでください！
4. コードは学生が問題を使用するときではなく、問題を保存するときにロードされます。したがって、コードは問題内にキャッシュされます。外部ライブラリへの更新は既存の問題には影響しません。そのキャッシュは、(a) STACK プラグインを更新する（すべてのキャッシュ/コンパイルされた問題をクリアします）、(b) 問題を保存する（コードを再度ダウンロードします）のいずれかを行わない限り無効になりません。

現時点では、不要なコードを削除するための「ツリーシェイキング（tree-shaking）」は行われないことに注意してください。使用しない関数を含む巨大なライブラリをインクルードした場合でも、問題はそれらの関数をCASにロードしなければならず、処理に時間がかかる可能性があります。多くの問題で使用されるライブラリがある場合は、それらをSTACK本体へ提供することを検討してください。

外部 CAS コードをインクルードするには、文字列引数を指定して `stack_include()` 関数を呼び出します。引数は、コードの URL を含む生の文字列でなければなりません。URLの文字列が格納された変数を参照することはできません。例えば

```maxima
a: rand(3)+2;
/* 表示を調整するためのロジックを読み込む */
stack_include("http://example.com/fragments/mytexputrules.txt");
/* 特殊なランダム化関数を組み込む */
stack_include("http://example.com/fragments/mymatrixrand.txt");
m: mymatrix_rand_integer_invertible(a);
```

`stack_include()` で評価フラグを使用することはできません。インクルードされるコード自体がフラグを含んでいる場合がありますが、インクルードの呼び出しによって、インクルードされるすべてのコンテンツにフラグを適用することはできません。

関数 `stack_include_contrib()` は、GitHub の master ブランチにある [STACK maxima contrib フォルダ](https://github.com/maths/moodle-qtype_stack/tree/master/stack/maxima/contrib) に含まれるファイルをロードします。
具体的には、`stack_include_contrib()` の引数の先頭に次の URL が付加されます：
`https://raw.githubusercontent.com/maths/moodle-qtype_stack/master/stack/maxima/contrib/`

したがって、以下は完全に等価です。

```maxima
stack_include("https://raw.githubusercontent.com/maths/moodle-qtype_stack/master/stack/maxima/contrib/validators.mac");
stack_include_contrib("validators.mac");
```

注意：

1. 私たちは contrib フォルダ内のファイルを小さく、安定したものに保つよう努めます。
2. 頻繁に使用される提供コードについては、適切な時期にSTACK本体へ移動させることを意図しています。その時点で、自動翻訳に対応できるよう言語文字列のローカライズを行います。
3. 命名規則については開発者に連絡してください。例えば、外部の検証関数は関数名を `validator_` で始める必要があります。
4. ライブラリをサーバー上でローカルに使用したい場合は、ファイル名の先頭に `contribl://` を付けてください。例えば `stack_include("contribl://matchlib.mac");` は GitHub 上のファイルではなく、ローカルファイルをロードします。これは主に、コードが master ブランチにプッシュされる前のローカル開発のための機能です。実際の運用中の問題でこれを使用することは推奨しません。

### サンドボックスでのテスト

`stack_include()` Maxima側に相当する機能が存在しないことに注意してください。そのため、デバッグのために問題変数をそのままMaximaにコピー＆ペーストすることはできません。インクルード操作は、手動で行う必要があります。

サンドボックスをセットアップする際に、 `stack_include_contrib()` は、ローカルの STACK ファイルからパッケージを読み込みます。ローカルマシン上の提供コードおよび他のファイルのバージョンが古くなっている可能性があるため、サンドボックス内のコードが最新のものであるか必ず確認してください。
