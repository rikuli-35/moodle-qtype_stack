# STACK-JS

このページでは、STACK-JSシステムについて解説する。STACK-JSは、問題の入力内容と出力されるコンテンツを、カスタムのブラウザ側JavaScriptロジックに接続するために使用される。通常、このロジックは `[[jsxgraph]]` ブロックや `[[javascript]]` ブロック内に記述される。動的な振る舞いを追加したいにも関わらず、既製の[CASTextブロック](../../../en/Authoring/Question_blocks/Dynamic_blocks.md)では対応できない場合、JavaScriptを使用することで実現できる可能性がある。

ただし、生のJavaScriptを直接使用すると、現在利用中のVLE（例：Moodle）のバージョン固有の動作に依存することになり、VLEの次回のアップデートやセキュリティ強化の際にスクリプトが動作しなくなるおそれがある。現在、STACKでは生のJavaScript（すなわち `<script>` タグの使用）と、STACK-JSが管理する制限付きサンドボックス内でのJavaScript実行の両方をサポートしている。後者は、限定的なインターフェースを提供しており、論理的に制限されたアクションを現在使用中のVLEの対応する機能にマッピングすることを目的としている。後者の利用を強く推奨しており、将来的に前者の使用を制限する可能性がある。

生のJavaScriptの使用を推奨しない技術的な理由については、安全なコンテキスト外で未知のJavaScriptを実行することに関連する[セキュリティ上の問題に関する簡潔な説明](../../../en/Developer/STACK-JS.md#the-general-security-reason)を参照できる。

## 基本的なインターフェース機能

STACK-JSインターフェースは非同期で動作する。要求された内容はすべてVLE（仮想学習環境）側に送信され、そこからの応答を待ってから結果を返す。そのため、応答を期待するアクションは、通常、結果として[Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)を返す。結果を取得するには、そのPromiseが解決された際に実行されるロジックを記述する必要がある。

以下の例は、VLE側にある特定の名前付き要素の内容を取得するロジックである。

    [[javascript]]
    // STACK-JSに名前付き要素のコンテンツ取得をリクエストする。
    let promise = stack_js.get_content('[[quid id="someelement"/]]');

    // コンテンツが準備できたら何らかの処理を行う。
    promise.then((content) => {
      if (content === null) {
       // 該当する要素が見つからなかった場合。
      } else {
        stack_js.toggle_visibility('[[quid id="otherelement"/]]', content.length % 2 == 0);
      }
    });
    [[/javascript]]

ここで、`stack_js.get_content()` 関数は、対象となる要素の `innerHTML`（要素が見つからない場合は `null`）を返す `Promise` を返すが、ロジックの一部がまだ起動中の可能性があるため、即座にその値が得られるわけではない。一方で、`stack_js.toggle_visibility()` は返す必要のある適切な値がないため、`Promise` を返さない。ただし、この関数も非同期で動作するため、このサンドボックスからVLE（仮想学習環境）への接続が準備完了になるまでは、表示状態は切り替わらない。

## 基本的な制約

STACK-JSシステムは、VLE（仮想学習環境）側でアクセスできるものや、VLE側に送信できるものを制限している。基本的なルールは以下の通りである。

 1. アクセスできるのは問題内の要素のみである。ロジックを含む問題のみに限定されるわけではないが、リクエストの範囲をその問題に限定することは可能である。基本的に、ページ上に存在していても、問題の表示領域の一部ではないVLEのコントロールやコンテンツには一切触れることができない。
 2. VLE側にコンテンツを送信する場合、フィルタリングなしで解答欄に入力されるか、名前付き要素の `innerHTML` を置換するために使用される。後者の場合、コンテンツ内のスクリプト、イベントハンドラ、および外部参照は除外される。つまり、サンドボックスからVLE側にロジックを移動させることはできない。

これらのルールに対する例外対応は受け付けていない。ただし、このルールの範囲内において、サンドボックス内のロジックから特定の問題にアクセスしたり操作したりするための、インターフェースの合理的な拡張要望については歓迎する。

## 関数

### 解答欄に関する関数

`stack_js.register_external_button_listener()` を除くすべての関数は、STACK問題内の解答欄名を使って対象を指定する。例外となる上記の関数のみ、要素IDで対象を指定する。また、これらの関数の多くはSTACK標準の解答欄だけでなく、手作業で作成した解答欄に対しても機能する。ただし、そのためには要素のID属性が「アンダースコア＋検索対象の名前（例: `..._name`）」で終わっている必要がある。このような名前を持つダミーの入力要素を作成する手法は、よく用いられる。

#### `stack_js.request_access_to_input(name, inputevents, limittoquestion)`

VLE側の特定の解答欄の値を追跡したい場合に使用する主要な関数である。この関数はサンドボックス側に入力要素を生成し、その値がVLE側の値と同期されることを保証する。ただし、以下の制約がある。

 1. VLE側での値の更新は、VLE側で `change` イベントが発生した時に行われる。また、`inputevents` 引数が `true` の場合は `input` イベント発生時にも更新される。なお、値が更新されるたびに、サンドボックス側でミラーリングされた入力要素が `change` イベントを発火するため、それを追跡できる。
 2. サンドボックス側の要素の値は、サンドボックス側で `change` イベントが発火したときにのみVLE側に送信される。したがって、JavaScriptで入力要素の値を書き換えるだけでは不十分であり、明示的にイベントを発火させる必要がある。これには `input.dispatchEvent(new Event('change'))` を使用する。

この関数は、値がVLE側と同期された時点で、サンドボックス側の入力要素のIDを返すPromiseを返す。`[[jsxgraph]]` ブロックや `[[javascript]]` ブロックのスタイル属性を使用して解答欄への参照を指定する場合、それらのブロックのコード全体は、それらの解答欄のPromiseが解決された後に実行される。

この関数の第2引数と第3引数はオプションである。第2引数のデフォルトは `false` で、`change` イベント時のみ更新を受信する。学生が入力中に即座に反応させたい場合は `true` に設定する。第3引数のデフォルトは `false` である。つまり、指定された `name` を持つ解答欄の検索はこのサンドボックスを含む問題に限定されない。この問題にその名前の解答欄がない場合、ページ上で最初に一致する解答欄が返される。これにより問題間の相互作用が可能になるが、含まれる問題のみを解答欄のソースにしたい場合は `true` に設定する。名前に一致する解答欄がない場合、（サンドボックスが非表示で実行されている場合を除き）エラーが明示される。

行列入力はサポートされておらず、より複雑な解答欄での動作は予期しない結果になる可能性がある。例えば、多肢選択の解答欄は基本的なテキスト入力にマッピングされ、チェックボックスの扱いは困難になる場合がある。

#### `stack_js.register_external_button_listener(id, callback)`

問題側にボタンを作成し、そのボタンが押された際に何らかの処理を行いたい場合、この関数を使用することで、ボタンのIDを指定してコールバック関数を割り当てることができる。この種のコールバックがボタンに接続された後は、フォームの送信機能が無効化されるため、ボタンを押してもフォームは送信されない点に注意する。同様に、このコールバック関数の戻り値は、他に設定されている可能性のあるコールバックの実行や、フォーム自体に対して影響を与えることはない。

コールバック関数は引数を1つ受け取る。この引数には、対象となるボタンのIDが渡される。

#### `stack_js.clear_input(name)`

指定された名前の解答欄が持つ値や選択状態をクリアする関数である。この関数を呼び出す前に `stack_js.request_access_to_input()` を使用する必要はない。

現時点では行列入力には対応していないことに注意する。

#### `stack_js.get_input_metadata(name)`

この関数は、`stack_js.request_access_to_input()` の呼び出し、または特定の簡易属性の指定によって、事前にサンドボックスへ接続された入力要素に関するメタデータを抽出する。このメタデータは、VLE側でのその解答欄のタイプや構文に関連する詳細を記述する。特に、使用されている小数点区切り文字を判定するために利用できる。

#### `stack_js.register_validation_state_listener(name, callback, limittoquestion)`

AJAX/即時バリデーションが接続されていることを前提とした解答欄にコールバック関数を登録する。そのバリデーションの状態が変化した場合（学生が入力を開始した時やバリデーション結果が返ってきた時など）にコールバック関数が呼び出される。

コールバック関数は3つの引数を受け取る。

 1. 第1引数は、バリデーションが現在進行中であるか（`false`）、完了したか（`true`）を示す。
 2. 第2引数はバリデーション結果を示す。バリデーションがまだ完了していない場合は `null` が、それ以外の場合は真偽値が渡される。
 3. 第3引数は解答欄の名前である。

なお、第3引数は `stack_js.request_access_to_input()` と同様で、登録時に使用した名前をそのまま返すだけである。そのため、この名前だけではその解答欄がこの問題に属するかどうかを判断することはできない。

この関数は、検索条件に一致する入力要素が見つからない場合にはエラーを発生させる。ただし、見つかった入力要素に実際にバリデーションが接続されているかどうかまでは把握しないため、イベントが一切生成されない状況であってもエラーにはならない。

最後に、この関数はあくまで状態変化時にコールバックを発火させるものであることに注意する。バリデーションメッセージから何かを読み取るタイミングを判断するためにこの関数を使用する場合、ページの読み込み時にも読み取るべき内容が既に存在していないか、併せて確認することを推奨する。

この機能の使用例はSTACKライブラリにあり、その例の説明は[こちら](Validation_state_listener.md)に記載されている。

### コンテンツに関する関数

コンテンツに関する関数は、常に要素をIDで対象指定する。一般に、アクセス制限が守られている限り、要素の種類は問わない。要素にIDを定義する際は、一意な識別子を生成するために [`[[quid]]`](../../Authoring/Question_blocks/Static_blocks.md#quid-question-unique-identifier-block) ブロックを使用することを強く推奨する。

#### `stack_js.toggle_visibility(elementid, show)`

対象要素のスタイルを変更する。第二引数が `true` の場合は `display:block` を、`false` の場合は `display:none` を設定する。このような仕様であるため、この機能は主にブロックレベル要素での使用を想定している。指定されたIDに一致する要素が見つからない場合は、（サンドボックスが非表示で実行されている場合を除き）エラーが明示される。

#### `stack_js.switch_content(elementid, newcontent)`

対象要素の `innerHTML` を指定されたコンテンツの文字列で置き換える。このコンテンツは、スクリプトや、以前の項目で説明したその他の要素が含まれていないかフィルタリングされる。指定されたIDに一致する要素が見つからない場合は、（サンドボックスが非表示で実行されている場合を除き）エラーが明示される。

#### `stack_js.get_content(elementid)`

対象要素の `innerHTML` を返す `Promise` を返す。該当する要素が見つからない場合は `null` を返す。この関数は、大きなデータセットを複数の場所で使用する場合や、PRTフィードバックまたは解答欄のバリデーションメッセージ内に配置されたメモを使用してデータをやり取りする場合に特に便利である。

### サンドボックスiframeに関する関数

#### `stack_js.resize_containing_frame(width, height)`

表示されているサンドボックスiframeの外部寸法を、初期化後に変更できる。コンテンツに合わせて自動的にサイズを適応させるようなプロット（グラフなど）に最適である。寸法は単位付きの文字列として指定する。

#### `stack_js.display_error(errmesg)`

表示されているサンドボックス内にエラーを視覚的に表示し、同時にブラウザのコンソールにもエラーを出力する。デバッグ作業の際に役立つ。

### 送信ボタンに関する関数

これらは、提出ボタンをカスタマイズしたいユーザーのための特定用途向け関数群である。例えば、特定の条件が満たされるまで提出ボタンを無効にするといった使い方が考えられる。提出ボタンは、適切な問題動作設定を使用している場合にのみ表示されることに注意する。

なお、この提出ボタンをプログラムから発火する関数は用意されていない。

#### `stack_js.has_submit_button()`

提出ボタンが存在するかどうかを示すブール値を返すPromiseを返す。

#### `stack_js.enable_submit_button(enable)`

提出ボタンを無効にしたり、再び有効にしたりすることができる。学生が使用できるように、必ず再度有効にすることを忘れないようにする。

#### `stack_js.relabel_submit_button(label)`

提出ボタンのテキスト（ラベル）を変更できる。
