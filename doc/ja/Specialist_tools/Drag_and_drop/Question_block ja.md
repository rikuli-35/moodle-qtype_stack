# パーソンズ問題（ドラッグ＆ドロップ）問題ブロック

パーソンズ問題は、あらかじめ記述されたテキストのブロックをドラッグしてツリー構造に配置し、正しい順序に組み立てることを学生に求める問題形式です。

このページは`[[parsons]] ... [[/ parsons]]` 問題ブロックに関するリファレンスドキュメントです。

問題作成者は、ブロック内にドラッグ対象となる文字列を事前に定義します。これらの文字列は、問題テキストでMaxima変数として定義するか、問題ブロック内で直接定義できます。

学生は文字列を操作し、ツリー構造へとドラッグして配置します。なお、リストは構造化されたツリーの特殊なケースであることに留意してください。このブロックはSTACKの解答欄にリンクできるため、学生が作成した構成を保存・評価することが可能です。なお、このページは `[[parsons]]` ブロックのリファレンスドキュメントです。このブロックを使った完全な問題の作成方法については、[パーソンズ問題の作成](Parsons.md)を参照してください。

## 基本的な使い方

基本的な使用例を以下に示します。

### 問題変数

問題作成者は、学生に表示するすべてのステップを `["key", "string"]` の形式のペアのリストとして記述します。`"string"` は問題ページで学生に表示される内容です。問題全体を通じて、問題作成者は `"key"` を使用してステップを参照します。なお、文字列内では `\` 文字をエスケープする必要があるため、例えば `\(n=2m+1\)` ではなく `\\(n=2m+1\\)` と記述する必要があります。

    stack_include_contrib("prooflib.mac");

    proof_steps: [
        ["assume", "Assume that \\(n\\) is odd."],
        ["ex", "Then there exists an \\(m\\in\\mathbb{Z}\\) such that \\(n=2m+1\\)."],
        ["expand", "\\[ n^2 = (2m+1)^2 = 2(2m^2+2m)+1.\\]"],
        ["def", "Define \\(M=2m^2+2m\\in\\mathbb{Z}\\) then \\(n^2=2M+1\\)."],
    ];

### 問題テキスト

    [[parsons input="ans1"]]
    {# parsons_encode(proof_steps) #}
    [[/parsons]]

## `[[parsons]]` ブロックのカスタマイズ

### JSONの「options」

`[[parsons]]` ブロックは、JavaScriptライブラリ「Sortable.js」のラッパーで、パーソンズ問題向けに最適化されたデフォルトオプションが設定されています。また、2つのリストのヘッダーなど、独自のデフォルト設定も追加されています。ブロック内容のJSONを以下のように構成することでカスタマイズできます。

    [[parsons input="ans1"]]
    { "steps": {# parsons_encode(proof_steps) #},
      "options": {"sortable option 1" : value, ..., "sortable option n" : value},
      "headers" : ["Custom header for the answer list"], 
    }
    [[/parsons]]

Sortable.jsの全オプション一覧は[SortableJS GitHub](https://github.com/SortableJS/Sortable#options)で確認できます。現在、これらのオプションのうち、アニメーション速度を制御する `animation` については、あらかじめデフォルト値が設定されています。

    {
        "animation": 50,
    }

ほとんどの他のSortableオプションは変更可能ですが、`ghostClass`、`group`、`onSort` は基本機能に必要なため変更できません。

未知のSortableオプションを入力した場合や、`ghostClass`、`group`、`onSort` に値を渡そうとした場合は、単に無視されます。この状況を示す警告が問題ページに表示されます。

`headers` と `available_header` のデフォルトは以下の通りです。

    {
        "headers": ["Construct your solution here:"], 
        "available_header": ["Drag from here:"]
    }

#### トラブルシューティング

パーソンズ問題が正しく表示されない場合、特にすべてのアイテムが1つの黄色いブロックにまとめて表示される場合は、Parsonsブロック内のJSONのキーが上記の説明通りに正しく記述されているか再確認してください。

キーは以下の集合の部分集合である必要があります。

    {"steps", "options", "headers", "available_header"}

かつ、以下の集合の上位集合である必要があります。

    {"steps"}

技術的な理由により、このエラーは現時点では検証できません。

### ブロックパラメータ

機能やスタイルは、ブロックパラメータを使用してカスタマイズできます。

1. `input`：文字列。STACKの解答欄変数の名前（例：`"ans1"`）です。内部の `state` パラメータとリンクしており、入力をMaximaの式として更新することで、PRTによる保存と評価を可能にします。
2. `height`：正の浮動小数点数と有効なCSS単位を含む文字列（例：`"480px"`、`"100%"` など）。デフォルトでは、読み込み時にすべてのコンテンツが収まるように自動的に高さが調整されます。ブロックヘッダに `height` パラメータの値を入力すると、ドラッグ＆ドロップリストを含むウィンドウの高さが固定され、自動リサイズが無効になります。ただし、その場合でも学生は展開ボタンを使用してウィンドウを自動的にリサイズすることが可能です。
3. `width`：正の浮動小数点数と有効なCSS単位を含む文字列（例：`"480px"`、`"100%"` など）。デフォルトは `"100%"` です。ドラッグ＆ドロップリストを含むウィンドウの幅を固定します。
4. `aspect-ratio`：0から1の間の浮動小数点数を含む文字列。`height`/`length` _または_ `width`のいずれか一方と組み合わせて使用でき、`aspect-ratio` の値に基づいて指定されなかったパラメータの値を自動的に決定します。デフォルトでは設定されていません。`aspect-ratio`、`width`、`height` _または_ `aspect-ratio`、`width`、`length` のすべてに値を設定するとエラーが発生します。
5. `clone`：`"true"` または `"false"` の形式の文字列。デフォルトは `"false"` です。`"false"` の場合、2つのリストが表示され、各証明ステップは一度きり」の使用になります。この場合、同じステップが繰り返される場合でも、問題作成者は必要なすべての証明ステップを記述する必要があります。`"true"` の場合、すべての証明ステップは何回でも無制限に再利用可能となり、ステップは利用可能なリストから解答リストへのみドラッグできるようになります。また、不要になったステップを整理するためのゴミ箱（bin）が表示されます。
6. `override-css`：`question/type/stack/corsscripts/` ディレクトリ内のローカルCSSファイルの場所を `cors://file-name` 形式で指定する文字列、または外部CSSスタイルシートへのhrefを含む文字列。これによりドラッグ＆ドロップリストのすべてのCSSスタイルが上書きされるため、使用には注意が必要です。独自のカスタムCSSファイルを作成し、その場所をこのパラメータに渡すことで、リストのスタイルをカスタマイズするために使用できます。このパラメータはデフォルトでは未設定です。
7. `override-js`：ローカルのJavaScriptライブラリまたはJavaScriptライブラリのCDNへのhrefを含む文字列。これにより、使用されているSortableライブラリが、文字列で指定されたライブラリで上書きされます。これは、Sortableライブラリの更新バージョンを使用したい場合や、カスタムライブラリで機能を追加したい場合に使用します。カスタムライブラリは、ベースとなるSortableの機能を拡張またはインポートする必要があることに注意してください。デフォルトでは未設定です。
8. `version`：`"local"` または `"cdn"` の形式の文字列。STACKのローカルコピーのSortableライブラリを使用するか、CDNからSortableのバージョン1.15.0を取得するかを指定します。デフォルトは `"local"` です。
9. `columns`：整数`"n"`を含む文字列。垂直方向の解答リストの表示数を指定します。デフォルトでは使用されません。指定した場合、スタイルは長さが指定されていない複数の垂直な解答リストを持つグリッド形式に変更されます。
10. `rows`：整数`"m"`を含む文字列。水平方向の解答リストの表示数を指定します。デフォルトでは使用されません。これを指定して、かつ `columns` が指定されていない場合、幅未指定の複数の水平な解答リストを持つグリッド形式に変更されます。`columns` と `rows` の両方が指定されている場合、固定の長さと幅を持つグリッド形式となり、アイテムをグリッド内の任意の位置に任意の順序でドラッグできます。`columns` を指定せずに `rows` のみを指定することはできません。
11. `transpose`：`"true"` または `"false"`。デフォルトは `"false"` です。学生は縦方向と横方向を自由に切り替えることができますが、読み込み時のデフォルトは列が縦方向です。横方向をデフォルトにしたい場合は `transpose="true"` を渡してください。
12. `log`：`"true"` または `"false"`。デフォルトは `"false"` です。`"true"` に設定すると、学生の解答データにその試行における全ドラッグ＆ドロップ操作の履歴と、各操作のタイムスタンプ（1970年1月1日 00:00 GMTからの経過秒数）が含まれます。

## Sortableオプション

`parsons` ブロック内で許可される最後のJSONキーは `"options"` で、その値にはドラッグ＆ドロップリストの機能をカスタマイズするためのオプションを含むJSONを指定できます。これらの含め方については[パーソンズガイド](Parsons.md)を、カスタマイズの詳細については[Sortableライブラリ](https://github.com/SortableJS/Sortable#options)を参照してください。

## `proof_step` の順序のランダム生成

学生がランダム化されたどの問題バリアントを閲覧したかを追跡し、後から確実に同じバリアントを再表示できるようにするためにはすべてのランダム化処理をMaximaレベルで実行する必要があります。

ランダムな順序を作成するには、`proof_steps` リストを使用してMaximaオブジェクトとしてステップを定義し（[テキストベースの証明を表現するCASライブラリ](../../Topics/Proof/Proof_CAS_library.md)のドキュメントを参照）、以下のように `proof_steps` をランダムに並べ替えます。

1. 通常通り変数 `proof_steps` を定義します。
2. 問題変数に `proof_steps:random_permutation(proof_steps);` を追加します。
3. ステップの順序を示す、簡潔で意味のある記録を作成するために、`{@map(first, proof_steps)@}` のような問題記録を追加します。

## ブロックとMaximaの連携

Parsonsブロックとのすべてのデータのやり取りには、JSON形式が使用されます。しかし、STACKの内部ではMaximaオブジェクトが使用されています。そのため、Maximaの構文とJSON形式の間でデータ変換を行う必要があります。

1. Maxima関数 `parsons_encode(proof_steps)` は、`proof_steps` のリストをハッシュ化されたキーを持つJSON文字列に変換します。
2. Maxima関数 `parsons_decode(ans1)` は、JSON文字列を[証明構成関数](../../Topics/Proof/Proof_CAS_library.md)に変換します。

### ブロックパラメータ：`height` と `width`

`height` や `width` などの追加表示オプションは、以下のようにヘッダに渡すこともできます。

    [[parsons input="ans1" height="360px" width="100%"]]
    {# parsons_encode(proof_steps) #}
    [[/parsons]]

## パーソンズブロックへのプロットの追加

パーソンズブロック内でドラッグする文字列にHTMLを埋め込むことができるため、通常通りHTMLの `<img>` タグを使用して画像を含めることができます。

STACKで生成された[プロット](../../CAS/Maxima_plot.md)も `{@plot(x^2,[x,-1,1])@}` を使用するだけで含めることができます。これが可能である理由は、内部の評価順序にあります。画像の完全なURLは、値がJavaScriptコードに代入された後に発生する一連の処理過程において初めて生成されるためです。

    proof_steps: [
    ["A", "The inverse function of \\(f(x)=x^2\\) has graph"],
    ["B", plot(x^2,[x,-1,1],[size,250,250])]
    ];

## 旧バージョン

バージョン (2024072500) において、STACKにおけるパーソンズ問題の処理方法が変更され、これをサポートするための特別な入力タイプが追加されました。
これにより、`proof_steps` 変数のキーがハッシュ化され、ブラウザの機能でWebページを検査してもキーが見えなくなります。
また、数値キーを使用した際に発生するランダム化のバグも修正されています（Issue [#1237](https://github.com/maths/moodle-qtype_stack/issues/1237) を参照）。

| 用途 | 旧バージョン | 新バージョン | |
|------|-------------|-------------|---|
| ブロック | `stackjson_stringify` | `parsons_encode` | |
| 解答欄 | `proof_parsons_key_json` | `parsons_answer` | テストケース構成で使用 |
| PRT | `proof_parsons_interpret` | `parsons_decode` | |

例：テストケースの構成では `parsons_answer([ta, proof_steps])` を使用します（`ta` はタグのリスト、`proof_steps` は証明ステップの配列）。

旧バージョンの問題は引き続きサポートされており、以前と同様に動作します。ただし、新しい関数を使用するように問題を更新することを強くお勧めします。一括テストによりアップグレードを促すメッセージが表示されます。

## 操作履歴の取得

ブロックヘッダで `log = "true"` を使用すると、提出される最終的な入力値には、その試行における操作履歴の内部表現と、各操作が行われたタイムスタンプを格納した配列が含まれます。タイムスタンプは、1970年1月1日 00:00 GMTからの経過秒数として測定されます。

問題変数に以下の `proof_steps` 変数が定義されている場合：

    proof_steps: [  
        ["assume_odd", "Assume that \\(n\\) is odd."],
        ["ex_odd", "Then there exists an \\(m\\in\\mathbb{Z}\\) such that \\(n=2m+1\\)."],
        ["expand", "\\[ n^2 = (2m+1)^2 = 2(2m^2+2m)+1.\\]"],
        ["def", "Define \\(M=2m^2+2m\\in\\mathbb{Z}\\) then \\(n^2=2M+1\\)."],
        ["assume_even", "Assume that \\(n\\) is even."],
        ["ex_even", "Then there exists an \\(m\\in\\mathbb{Z}\\) such that \\(n = 2m\\)."]
    ];

操作履歴は以下の形式になります。

    [
        [
            {"used" : ["assume_odd", ...], "available" : []}, 
            1723723269679
        ],
        [
            {"used" : ["assume_odd", ...], "available" : [...]}, 
            1723723269675
        ],
        ...
        [
            {"used" : [], "available" : ["assume_odd", ...]},
            1723723269667
        ]
    ]
